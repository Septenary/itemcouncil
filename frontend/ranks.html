<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Guild Rankings</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1e1e1e;
            color: #ddd;
        }

        h1 {
            margin-bottom: 20px;
            text-align: center;
        }

        #rankings-container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .character {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #ccc;
        }

        .character h2 {
            margin-top: 0;
            margin-bottom: 12px;
        }

        .zones-flex {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .zone-box {
            background: #222;
            padding: 10px;
            border-radius: 6px;
            flex: 1 1 calc(33.333% - 13.333px);
            min-width: 280px;
            box-sizing: border-box;
        }

        .zone-stats-grid {
            display: grid;
            grid-template-columns: .5fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .zone-stats-grid p {
            margin: 0;
        }


        .encounter {
            padding: 6px 12px;
            border-radius: 4px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            background: #1c1c1c;
            align-items: center;
            border-left: 5px solid #666;
        }
    </style>
</head>

<body>

    <div id="rankings-container">Loading...</div>

    <script>
        function getLastWeekDateString() {
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);

            const year = lastWeek.getFullYear();
            const month = String(lastWeek.getMonth() + 1).padStart(2, '0');
            const day = String(lastWeek.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        function insertAuditLogLinks() {
            const minDate = getLastWeekDateString();
            const baseUrl = 'https://thatsmybis.com/22539/impulse/audit-log';

            const links = [
                {
                    type: 'prio',
                    label: 'View Prio Audit Log (Past Week)'
                },
                {
                    type: 'wishlist',
                    label: 'View Wishlist Audit Log (Past Week)'
                }
            ];

            const container = document.createElement('div');
            container.style.textAlign = 'center';
            container.style.margin = '20px 0';

            links.forEach(link => {
                const url = `${baseUrl}?type=${link.type}&min_date=${minDate}`;
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.style.color = '#4eaaff';
                a.style.fontWeight = 'bold';
                a.style.textDecoration = 'underline';
                a.style.display = 'inline-block';
                a.style.margin = '6px 12px';
                a.textContent = link.label;
                container.appendChild(a);
            });

            const parent = document.getElementById('rankings-container');
            if (parent) {
                parent.parentNode.insertBefore(container, parent);
            }
        }

        document.addEventListener('DOMContentLoaded', insertAuditLogLinks);
    </script>


    <script>
        const classColors = {
            2: '#FF7D0A',
            3: '#ABD473',
            4: '#69CCF0',
            5: '#0070DE',
            6: '#F58CBA',
            7: '#FFFFFF',
            8: '#FFF569',
            10: '#9482C9',
            11: '#C79C6E',
        };

        const zoneIDs = [1028, 1034, 1035];

        function getRankColor(rankPercent) {
            if (rankPercent === null || rankPercent === undefined) return '#888';
            if (rankPercent > 99.9) return '#ffd700';  // Gold
            if (rankPercent >= 99) return '#ff69b4';   // Pink
            if (rankPercent >= 95) return '#ff8c00';   // Orange
            if (rankPercent >= 75) return '#800080';   // Purple
            if (rankPercent >= 50) return '#0000ff';   // Blue
            if (rankPercent >= 25) return '#008000';   // Green
            return '#888';                             // Grey
        }

        function formatPartition(partition) {
            switch (partition) {
                case -1: return 'All Phases';
                case 1: return 'P1/P2';
                case 2: return 'P3/P4';
                case 3: return 'P5/P6';
                default: return 'N/A';
            }
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return 'N/A';
            return Math.floor(value) + '%';
        }

        function renderEncounter(encounter) {
            const color = getRankColor(encounter.rankPercent);
            return `
      <div class="encounter" style="border-left: 5px solid ${color}">
        <div>${encounter.encounter?.name ?? 'Unknown Encounter'}</div>
        <div style="color:${color}; font-weight: bold;">
          ${formatPercent(encounter.rankPercent)}
        </div>
      </div>
    `;
        }

        function renderPerformanceStat(label, value) {
            if (value === null || value === undefined) {
                return `<strong>${label}:</strong> N/A`;
            }
            const color = getRankColor(value);
            return `<p><strong>${label}:</strong> <span style="color: ${color};">${Math.round(value)}%</span></p>`;
        }

        function renderPartition(partition) {
            return `<p><strong>${formatPartition(partition)}</strong></p>`;
        }

        function renderZone(zoneData) {
            const zoneNames = {
                1028: "Molten Core",
                1034: "Blackwing Lair",
                1035: "Temple of Ahn'Qiraj",
            };

            const zoneName = zoneNames[zoneData.zone] || `Zone ${zoneData.zone ?? 'N/A'}`;
            const rankingsHTML = Array.isArray(zoneData.rankings) && zoneData.rankings.length > 0
                ? zoneData.rankings.map(renderEncounter).join('')
                : '<em>No ranking data</em>';

            return `
                <div class="zone-box">
<h3>
  <a
    href="https://fresh.warcraftlogs.com/character/id/${zoneData.characterID}?zone=${zoneData.zone}&partition=${zoneData.partition}"
    target="_blank"
    rel="noopener noreferrer"
    style="color: #4eaaff; text-decoration: none;"
  >
    ${zoneName}
  </a>
</h3>
                    ${renderPartition(zoneData.partition)}
                    <div class="zone-stats-grid">
                    <p><strong>${zoneData.metric ?? 'N/A'}</strong></p>
                    ${renderPerformanceStat('Best', zoneData.bestPerformanceAverage)}
                    ${renderPerformanceStat('Median', zoneData.medianPerformanceAverage)}
                    </div>
                    ${rankingsHTML}
                </div>
                `;
        }

        function monthsSince(raw) {
            if (!raw || typeof raw !== 'string') return 'Join Date unknown';

            const cleaned = raw.replace(/^!!/, '').trim();

            // Normalize: "17 Jul '25" â†’ "17 Jul 2025"
            const match = cleaned.match(/^(\d{1,2})\s([A-Za-z]{3})\s'(\d{2})$/);
            if (!match) return cleaned;

            const [, day, mon, yr] = match;
            const fullDateStr = `${day} ${mon} 20${yr}`;
            const parsedDate = new Date(Date.parse(fullDateStr));

            if (isNaN(parsedDate)) return cleaned;

            const now = new Date();
            let months =
                (now.getFullYear() - parsedDate.getFullYear()) * 12 +
                (now.getMonth() - parsedDate.getMonth());

            if (now.getDate() < parsedDate.getDate()) months--;

            return months < 1
                ? 'Joined less than a month ago'
                : `Joined ${months} month${months !== 1 ? 's' : ''} ago`;
        }

        function renderGuildMembers(membersArray) {
            const container = document.getElementById('rankings-container');
            container.innerHTML = '';

            membersArray.forEach(char => {
                const color = classColors[char.classID] || '#ccc';

                const charDiv = document.createElement('div');
                charDiv.classList.add('character');
                charDiv.style.borderColor = color;

                let html = `
                <h2>
                    <a 
                    href="https://classic.warcraftlogs.com/character/us/dreamscythe/${encodeURIComponent(char.name)}"
                    target="_blank"
                    rel="noopener noreferrer"
                    style="color:${color}; text-decoration: none;"
                    >
                    ${char.name}
                    </a>
                </h2>
                `;
                html += `<p><strong>Join Date:</strong> ${monthsSince(char.joinDate)}</p>`;

                html += `<div class="zones-flex">`;
                zoneIDs.forEach(zoneID => {
                    const zoneData = char.zones[zoneID];
                    if (zoneData) {
                        html += renderZone(zoneData);
                    } else {
                        html += `
            <div class="zone-box">
              <h3>Zone ${zoneID}</h3>
              <em>No data available</em>
            </div>
          `;
                    }
                });
                html += `</div>`;

                charDiv.innerHTML = html;
                container.appendChild(charDiv);
            });
        }

        async function loadRankingsForZones() {
            const container = document.getElementById('rankings-container');
            container.innerHTML = 'Loading...';

            try {
                // Fetch rankings per zone, same as before
                const rankingResponses = await Promise.all(
                    zoneIDs.map(zoneID =>
                        fetch(`http://127.0.0.1:8080/api/rankings?zoneID=${zoneID}`).then(r => r.json())
                    )
                );

                // Fetch grm data with join dates
                const grmResponse = await fetch('http://127.0.0.1:8080/api/grm');
                const grmJson = await grmResponse.json();

                // Build a name->joinDate map
                const joinDateMap = {};
                (grmJson.data || []).forEach(member => {
                    joinDateMap[member.Name] = member['Join Date'] || 'N/A';
                });

                // Combine ranking data per member, same as before
                const combinedCharacters = {};
                rankingResponses.forEach((response, i) => {
                    const zoneID = zoneIDs[i];
                    const members = response?.data?.guildData?.guild?.members?.data || [];

                    members.forEach(member => {
                        const { id, name, classID, zoneRankings } = member;
                        if (!combinedCharacters[name]) {
                            combinedCharacters[name] = {
                                id,
                                name,
                                classID,
                                zones: {}
                            };
                        }
                        if (zoneRankings?.zone === zoneID) {
                            combinedCharacters[name].zones[zoneID] = {
                                ...zoneRankings,
                                characterID: id
                            };
                        }
                    });
                });

                // Add joinDate to each member from the map
                Object.values(combinedCharacters).forEach(char => {
                    char.joinDate = joinDateMap[char.name] || 'Unknown';
                });

                renderGuildMembers(Object.values(combinedCharacters));
            } catch (err) {
                container.innerHTML = `<p style="color:red;">Failed to load rankings: ${err.message}</p>`;
                console.error(err);
            }
        }

        loadRankingsForZones();
    </script>



</body>

</html>